version: '3.8'

x-app-base: &app-base
  build: .
  volumes:
    - ./src:/app/src
  ports:
    - "8000:3000"
  env_file:
    - .env
  depends_on:
    redis:
      condition: service_healthy

services:
  redis:
    image: redis:7-alpine
    container_name: searcrawl_redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    restart: unless-stopped

  searxng:
    image: searxng/searxng:latest
    container_name: searcrawl_searxng
    profiles:
      - searxng
      - full
    ports:
      - "8080:8080"
    volumes:
      - ./searxng:/etc/searxng:rw
    environment:
      - SEARXNG_BASE_URL=http://localhost:8080/
      - SEARXNG_SECRET=$${SEARXNG_SECRET:-ultrasecretkey}
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
    logging:
      driver: "json-file"
      options:
        max-size: "1m"
        max-file: "1"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8080/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3

  reader:
    image: ghcr.io/intergalacticalvariable/reader:latest
    container_name: searcrawl_reader
    profiles:
      - reader
      - full
    volumes:
      - ./reader_data/local:/app/local-storage
    ports:
      - "3001:3000"
    restart: unless-stopped

  app:
    <<: *app-base
    container_name: searcrawl_app
    profiles:
      - default
      - searxng
    environment:
      - REDIS_URL=redis://redis:6379/0
      - SEARXNG_URL=$${SEARXNG_URL:-http://searxng:8080}
      - READER_ENABLED=false

  app-reader:
    <<: *app-base
    container_name: searcrawl_app_reader
    profiles:
      - reader
      - full
    depends_on:
      redis:
        condition: service_healthy
      reader:
        condition: service_started
    environment:
      - REDIS_URL=redis://redis:6379/0
      - SEARXNG_URL=$${SEARXNG_URL:-http://searxng:8080}
      - READER_URL=http://reader:3000
      - READER_ENABLED=true

volumes:
  redis_data:
